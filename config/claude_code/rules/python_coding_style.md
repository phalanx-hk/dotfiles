---
paths: **/*.py
---

このルールを使用するときには、回答時に 🐍 の絵文字をつけてください。

# python スタイルガイド

## 前提

- python のバージョンは3.12以上を前提としています。
- コードの可読性と保守性を重視し、PEP8 に準拠したスタイルを採用します。

## 依存関係管理

依存関係の管理には`uv`を使用しています。`pip`は禁止としているため、`uv`を使用してパッケージのインストールや仮想環境の管理を行ってください。


## 型安全性とエラーハンドリング

### 型アノテーション

#### 基本方針

- 全ての関数とメソッドに型アノテーションを記載する
- 型アノテーションは PEP585 に従い、`typing.List` や `typing.Dict` ではなく、組み込みの `list` や `dict` を使用する
- mypy の型チェックを必ず通すこと
- `typing.Any`は極力使用しない。ただし、外部ライブラリや動的なデータ構造を扱う場合は例外とする
- 型の複雑さよりも可読性を優先し、必要に応じて Type Alias や NewType を使用して可読性を向上させる、もしくは pydantic などのデータモデルを使用する

#### TypeAlias vs NewType vs Pydantic の使い分け

##### TypeAlias

- 可読性を向上させるために使用しますが、型安全性は提供しません。
- ドメインコードをコードに明示的に示したいが、型安全性は必要ない場合に使用します。
- `typing.TypeAlias`は 3.12 から非推奨となり、`type`を使って型エイリアスであることを明示することが推奨されています。

```python
UserId: type = int
```

##### NewType

- 型安全性を確保するために使用します。
- ランタイムでは同じ型として扱われるため、型チェックツール（mypy など）でのみ効果があります。
- ID, 単位, 為替レートなど「値は同じ型でも混ぜたら危険」な場面、ランタイム性能を落とさずに静的解析で早期にバグを見つけるために使用します。

```python
from typing import NewType

UserId = NewType('UserId', int)

def get_user_name(user_id: UserId) -> str:
    ...

  get_user_name(UserId(123))  # 型安全性が確保される
  get_user_name(123)  # mypy エラー
```

##### Pydantic

- データのバリデーションとシリアライゼーションを行うために使用します。
- データモデルを定義し、実行時にデータの整合性
- API や外部ファイルなど、信頼できないデータソースからの入力を扱う場合に使用します。

### エラーハンドリング

#### 基本方針

- 具体的な例外タイプをキャッチし、`Exception` の汎用キャッチは避ける
- 例外の再発生時は context を保持する（`raise ... from e`）
- カスタム例外クラスでドメインエラーを表現する

## Docstring

- Google style のドキュメンテーション文字列（docstring）を使用
- 記載内容:
  - 関数/クラスの機能を簡潔に説明
  - Args: 引数の説明
  - Returns: 戻り値の説明
  - Raises: どのような例外が発生するかを記載
